name: build

on:
    push:
        branches:
            - "main"
    workflow_dispatch:

jobs:
    upload_mirrorc:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Version Name
            id: version_name
            run: |
              version=$(python .github/version.py resource/version.json)
              echo "version=$version" | tee -a "$GITHUB_OUTPUT"

          - name: Zip
            id: zip
            run: |
              cd ../
              rm -rf ${{ github.event.repository.name }}.zip
              zip -r ${{ github.event.repository.name }}.zip ${{ github.event.repository.name }} -x ".git/*" ".github/*"
          
          - uses: actions/upload-artifact@v4
            with:
                name: MirrorChyanPackage
                path: "../${{ github.event.repository.name }}.zip"
                
          - name: Upload to MirrorChyan
            run: |
              cd ../
              curl --location --request POST 'https://mirrorc.top/api/resources/${{ github.event.repository.name }}/versions' \
                --header 'Authorization:1' \
                --form 'name="${{ steps.version_name.outputs.version }}"' \
                --form 'file=@"${{ github.event.repository.name }}.zip"'
